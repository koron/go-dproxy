name: Go

on: [push]

env:
  GO_VERSION: '>=1.24.0'

jobs:

  build:
    name: Build
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os:
        - ubuntu-latest
        - ubuntu-24.04-arm
        - macos-latest
        - windows-latest

    steps:

    - uses: actions/checkout@v5

    - uses: actions/setup-go@v6
      with:
        go-version: ${{ env.GO_VERSION }}

    - run: go test ./...

    - name: Build all "main" packages
      shell: bash
      run: |
        go list -f '{{if (eq .Name "main")}}{{.ImportPath}} .{{slice .ImportPath (len .Module.Path)}}{{end}}' ./... | while IFS= read -r line ; do
          read -a e <<< "$line"
          path="${e[0]}"
          dir="${e[1]}"
          name=$(basename $path)
          printf "building %s\t(%s)\n" $name $dir
          ( cd "$dir" && go build )
        done

# based on: github.com/koron-go/_skeleton/.github/workflows/go.yml
# $Hash:f6e26da7ac7beb9f6537cdc2ca874387c7f0208429fa08e84c8e489c$
